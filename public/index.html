<html>
<head>
</head>

<body>

<script src="javascripts/webcam.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<div id="my_camera" style="width:320px; height:240px;"></div>
<div id="my_result"></div>
<button id="btn">CLICK HERE HA</button>
<button id="start">S T A R T</button>
<button id="stop">S T O P</button>

<script language="JavaScript">

	var emotion_list = [];
	var position_list = [];
	var refreshIntervalId;
	var toBlob = function(data_uri, type) {
	    var bytes = atob(data_uri.split(',')[1])
	    var arr = new Uint8Array(bytes.length);
	    for (var i = 0; i < bytes.length; i++) {
	    	arr[i] = bytes.charCodeAt(i);
	    }
	  return new Blob([arr], { type: type || 'image/png' });
	};

	var apiUrl = "https://api.projectoxford.ai/emotion/v1.0/recognize";
	var apiKey = "b17f4f01d83f40d98380852bfcf3c6a9"

    Webcam.attach( '#my_camera' );

    function take_snapshot() {
        Webcam.snap( function(data_uri) {
            document.getElementById('my_result').innerHTML = '<img src="'+data_uri+'"/>';
        } );
    }

    $("#btn").click(function(){
    	callAPI(apiUrl, apiKey);
    });

    $("#start").click(function(){
    	refreshIntervalId = setInterval(function(){
    		callAPI(apiUrl, apiKey);
    	}, 1500);
    });

    $("#stop").click(function(){
    	clearInterval(refreshIntervalId);
    });


    function callAPI(apiUrl, apiKey){
    	Webcam.snap(function(data_uri, canvas, context){
	    	$.ajax({
	    		url: apiUrl, 
	    		beforeSend: function (xhrObj){
					xhrObj.setRequestHeader("Content-Type", "application/octet-stream");
					xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", apiKey);
				},
	    		type: "POST", 
	    		data: toBlob(data_uri, "image/png"), 
	    		processData: false
	    	})
	    	.done(function(response){
	    		console.log(response);
	    		emotion_list.push(response[0].scores);
	    		position_list.push(response[0].faceRectangle);
	    	});
	    });
    }

</script>

<a href="javascript:void(take_snapshot())">Take Snapshot</a>

</body>
</html>